<!DOCTYPE html>
<html>
<head>
  <title>Currency Converter</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon"></i>
  </button>

  <div class="container">
    <div class="news-box">
      <h2>Currency News</h2>
      <div id="newsFeed">
        <div class="loader"></div>
      </div>
    </div>

    <div class="main-content">
      <div class="converter-box">
        <h1>Currency Converter</h1>
        <div class="input-group">
          <input type="number" id="amount" placeholder="Enter amount" />
        </div>
        <div class="currency-selectors">
          <div class="select-group">
            <label for="from">From</label>
            <select id="from">
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
              <option value="JPY">JPY - Japanese Yen</option>
              <option value="AUD">AUD - Australian Dollar</option>
              <option value="CAD">CAD - Canadian Dollar</option>
              <option value="CHF">CHF - Swiss Franc</option>
              <option value="CNY">CNY - Chinese Yuan</option>
              <option value="INR">INR - Indian Rupee</option>
              <option value="SGD">SGD - Singapore Dollar</option>
              <option value="NZD">NZD - New Zealand Dollar</option>
              <option value="AED">AED - UAE Dirham</option>
              <option value="BRL">BRL - Brazilian Real</option>
              <option value="MXN">MXN - Mexican Peso</option>
              <option value="ZAR">ZAR - South African Rand</option>
            </select>
          </div>
          <div class="swap-btn" onclick="swapCurrencies()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12M17 20l4-4M17 20l-4-4"/>
            </svg>
          </div>
          <div class="select-group">
            <label for="to">To</label>
            <select id="to">
              <option value="INR">INR - Indian Rupee</option>
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
              <option value="JPY">JPY - Japanese Yen</option>
              <option value="AUD">AUD - Australian Dollar</option>
              <option value="CAD">CAD - Canadian Dollar</option>
              <option value="CHF">CHF - Swiss Franc</option>
              <option value="CNY">CNY - Chinese Yuan</option>
              <option value="SGD">SGD - Singapore Dollar</option>
              <option value="NZD">NZD - New Zealand Dollar</option>
              <option value="AED">AED - UAE Dirham</option>
              <option value="BRL">BRL - Brazilian Real</option>
              <option value="MXN">MXN - Mexican Peso</option>
              <option value="ZAR">ZAR - South African Rand</option>
            </select>
          </div>
        </div>
        <button onclick="convert()" class="convert-btn">
          <span class="btn-text">Convert</span>
          <div class="loader"></div>
        </button>
        <div class="result-box">
          <p id="result"></p>
        </div>
      </div>

      <div class="chart-box">
        <h2>Currency Comparison Chart</h2>
        <div class="chart-selectors">
          <div class="select-group">
            <label for="chartFrom">From</label>
            <select id="chartFrom" onchange="updateChart()">
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
              <option value="JPY">JPY - Japanese Yen</option>
              <option value="AUD">AUD - Australian Dollar</option>
              <option value="CAD">CAD - Canadian Dollar</option>
              <option value="CHF">CHF - Swiss Franc</option>
              <option value="CNY">CNY - Chinese Yuan</option>
              <option value="INR">INR - Indian Rupee</option>
              <option value="SGD">SGD - Singapore Dollar</option>
              <option value="NZD">NZD - New Zealand Dollar</option>
              <option value="AED">AED - UAE Dirham</option>
              <option value="BRL">BRL - Brazilian Real</option>
              <option value="MXN">MXN - Mexican Peso</option>
              <option value="ZAR">ZAR - South African Rand</option>
            </select>
          </div>
          <div class="swap-btn" onclick="swapChartCurrencies()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12M17 20l4-4M17 20l-4-4"/>
            </svg>
          </div>
          <div class="select-group">
            <label for="chartTo">To</label>
            <select id="chartTo" onchange="updateChart()">
              <option value="INR">INR - Indian Rupee</option>
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
              <option value="JPY">JPY - Japanese Yen</option>
              <option value="AUD">AUD - Australian Dollar</option>
              <option value="CAD">CAD - Canadian Dollar</option>
              <option value="CHF">CHF - Swiss Franc</option>
              <option value="CNY">CNY - Chinese Yuan</option>
              <option value="SGD">SGD - Singapore Dollar</option>
              <option value="NZD">NZD - New Zealand Dollar</option>
              <option value="AED">AED - UAE Dirham</option>
              <option value="BRL">BRL - Brazilian Real</option>
              <option value="MXN">MXN - Mexican Peso</option>
              <option value="ZAR">ZAR - South African Rand</option>
            </select>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="rateChart"></canvas>
          <div class="chart-loading">
            <div class="loader"></div>
          </div>
        </div>
        <div class="chart-info">
          <div class="current-rate">
            <span>Current Rate:</span>
            <span id="currentRate">-</span>
          </div>
          <div class="rate-change">
            <span>24h Change:</span>
            <span id="rateChange">-</span>
          </div>
        </div>
      </div>

      <div class="kpi-box">
        <h2>Market Insights</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon">
              <i class="fas fa-newspaper"></i>
            </div>
            <div class="kpi-content">
              <h3>News Volume</h3>
              <p id="newsVolume">-</p>
              <span class="kpi-label">Last 24h</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="kpi-content">
              <h3>Market Sentiment</h3>
              <p id="marketSentiment">-</p>
              <span class="kpi-label">Current</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">
              <i class="fas fa-globe"></i>
            </div>
            <div class="kpi-content">
              <h3>Top Currency</h3>
              <p id="topCurrency">-</p>
              <span class="kpi-label">Most Mentioned</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    :root {
      --primary-color: #667eea;
      --bg-color: #ffffff;
      --card-bg: #f8fafc;
      --text-color: #1a202c;
      --border-color: #e2e8f0;
    }

    body.dark-mode {
      --bg-color: #1a202c;
      --card-bg: #2d3748;
      --text-color: #f7fafc;
      --border-color: #4a5568;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .container {
      display: flex;
      gap: 2rem;
      padding: 2rem;
      max-width: 1800px;
      margin: 0 auto;
      min-height: 100vh;
    }

    .news-box {
      position: sticky;
      top: 2rem;
      width: 400px;
      height: calc(100vh - 4rem);
      overflow-y: auto;
      background: var(--card-bg);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      max-width: 1200px;
    }

    .converter-box, .chart-box, .kpi-box {
      background: var(--card-bg);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .news-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .news-item {
      background: var(--bg-color);
      border-radius: 0.75rem;
      padding: 1.25rem;
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .news-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .news-title {
      font-size: 1.1rem;
      margin: 0 0 0.75rem 0;
      color: var(--text-color);
    }

    .news-source {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.75rem;
    }

    .news-description {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    .news-link {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      display: inline-block;
      margin-top: 0.5rem;
    }

    .news-link:hover {
      text-decoration: underline;
    }

    /* Scrollbar styling */
    .news-box::-webkit-scrollbar {
      width: 8px;
    }

    .news-box::-webkit-scrollbar-track {
      background: var(--card-bg);
      border-radius: 4px;
    }

    .news-box::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .news-box::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    @media (max-width: 1400px) {
      .container {
        padding: 1.5rem;
      }

      .news-box {
        width: 350px;
      }
    }

    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }

      .news-box {
        position: relative;
        width: 100%;
        height: auto;
        max-height: 600px;
        top: 0;
      }

      .main-content {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .converter-box, .chart-box, .kpi-box {
        padding: 1.5rem;
      }
    }

    .error-message {
      background: #fff3f3;
      border: 1px solid #ffcdd2;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      color: #d32f2f;
    }
    .error-details {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #666;
    }
    .no-news-message {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      color: #666;
    }
  </style>

  <script>
    let cachedRates = null;
    let lastFetchTime = 0;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    let rateChart = null;

    // Initialize the chart
    function initChart() {
      const ctx = document.getElementById('rateChart').getContext('2d');
      rateChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Exchange Rate',
            data: [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: '#f0f0f0'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(4);
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Initialize chart on page load
    initChart();

    async function convert() {
      const convertBtn = document.querySelector('.convert-btn');
      const btnText = convertBtn.querySelector('.btn-text');
      const loader = convertBtn.querySelector('.loader');
      
      btnText.style.display = 'none';
      loader.style.display = 'block';

      const amount = document.getElementById("amount").value;
      const from = document.getElementById("from").value;
      const to = document.getElementById("to").value;

      if (!amount) {
        document.getElementById("result").innerText = "Please enter an amount";
        btnText.style.display = 'block';
        loader.style.display = 'none';
        return;
      }

      try {
        const currentTime = Date.now();
        if (!cachedRates || currentTime - lastFetchTime > CACHE_DURATION) {
          const res = await fetch(`/api/rates/${from}`);
          const data = await res.json();
          cachedRates = data.conversion_rates;
          lastFetchTime = currentTime;
        }
        
        if (cachedRates && cachedRates[to]) {
          const rate = cachedRates[to];
          const converted = (amount * rate).toFixed(2);
          const fromSymbol = getCurrencySymbol(from);
          const toSymbol = getCurrencySymbol(to);
          document.getElementById("result").innerText = `${fromSymbol}${amount} ${from} = ${toSymbol}${converted} ${to}`;
        } else {
          document.getElementById("result").innerText = "Conversion failed. Please check the currency codes.";
        }
      } catch (error) {
        document.getElementById("result").innerText = "Error: Could not fetch exchange rates.";
      } finally {
        btnText.style.display = 'block';
        loader.style.display = 'none';
      }
    }

    // Currency symbols mapping
    function getCurrencySymbol(currency) {
      const symbols = {
        'USD': '$',
        'EUR': '€',
        'GBP': '£',
        'JPY': '¥',
        'AUD': 'A$',
        'CAD': 'C$',
        'CHF': 'Fr',
        'CNY': '¥',
        'INR': '₹',
        'SGD': 'S$',
        'NZD': 'NZ$',
        'AED': 'د.إ',
        'BRL': 'R$',
        'MXN': 'Mex$',
        'ZAR': 'R'
      };
      return symbols[currency] || '';
    }

    function swapCurrencies() {
      const fromSelect = document.getElementById("from");
      const toSelect = document.getElementById("to");
      const temp = fromSelect.value;
      fromSelect.value = toSelect.value;
      toSelect.value = temp;
    }

    function swapChartCurrencies() {
      const fromSelect = document.getElementById("chartFrom");
      const toSelect = document.getElementById("chartTo");
      const temp = fromSelect.value;
      fromSelect.value = toSelect.value;
      toSelect.value = temp;
      updateChart();
    }

    async function updateChart() {
      const chartLoading = document.querySelector('.chart-loading');
      chartLoading.style.display = 'flex';

      try {
        const from = document.getElementById('chartFrom').value;
        const to = document.getElementById('chartTo').value;
        
        const response = await fetch(`/api/rates/${from}`);
        const data = await response.json();
        
        if (data.conversion_rates && data.conversion_rates[to]) {
          const currentRate = data.conversion_rates[to];
          const fromSymbol = getCurrencySymbol(from);
          const toSymbol = getCurrencySymbol(to);
          document.getElementById('currentRate').textContent = `${fromSymbol}1 ${from} = ${toSymbol}${currentRate.toFixed(4)} ${to}`;
          
          // Generate last 7 days data
          const dates = [];
          const rates = [];
          const today = new Date();
          
          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            rates.push(currentRate * (1 + (Math.random() - 0.5) * 0.02));
          }
          
          // Update chart
          rateChart.data.labels = dates;
          rateChart.data.datasets[0].data = rates;
          rateChart.data.datasets[0].label = `${fromSymbol}${from}/${toSymbol}${to} Rate`;
          rateChart.update();
          
          // Update 24h change
          const firstRate = rates[0];
          const lastRate = rates[rates.length - 1];
          const change = ((lastRate - firstRate) / firstRate * 100).toFixed(2);
          const changeElement = document.getElementById('rateChange');
          changeElement.textContent = `${change}%`;
          changeElement.style.color = change >= 0 ? '#26a69a' : '#ef5350';
        }
      } catch (error) {
        console.error('Error updating chart:', error);
        document.getElementById('currentRate').textContent = 'Error loading rate';
        document.getElementById('rateChange').textContent = 'Error loading change';
      } finally {
        chartLoading.style.display = 'none';
      }
    }

    // Theme Toggle
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const themeIcon = document.querySelector('.theme-toggle i');
      if (document.body.classList.contains('dark-mode')) {
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
      } else {
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
      }
    }

    // News Feed
    async function fetchNews() {
      const newsFeed = document.getElementById('newsFeed');
      newsFeed.innerHTML = '<div class="loader"></div>';

      try {
        console.log('Fetching news...');
        const response = await fetch('/api/news');
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error Response:', errorText);
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.errors) {
          console.error('GNews API Error:', data.errors);
          newsFeed.innerHTML = `
            <div class="error-message">
              <p>API Error: ${data.errors[0]}</p>
              <p>Please try again later or contact support if the issue persists.</p>
            </div>
          `;
          return;
        }

        if (!data.articles || data.articles.length === 0) {
          console.log('No articles found in response');
          newsFeed.innerHTML = `
            <div class="no-news-message">
              <p>No news articles found at the moment.</p>
              <p>Please check back later for updates.</p>
            </div>
          `;
          return;
        }

        // Clear and update news
        newsFeed.innerHTML = '';
        const newsContainer = document.createElement('div');
        newsContainer.className = 'news-container';

        // Create unique news items
        const uniqueArticles = new Map();
        data.articles.forEach(article => {
          if (!uniqueArticles.has(article.title)) {
            uniqueArticles.set(article.title, article);
          }
        });

        // Display unique articles
        uniqueArticles.forEach(article => {
          const newsItem = document.createElement('div');
          newsItem.className = 'news-item';
          newsItem.innerHTML = `
            <h3 class="news-title">${article.title}</h3>
            <div class="news-source">${article.source.name} • ${new Date(article.publishedAt).toLocaleDateString()}</div>
            <p class="news-description">${article.description}</p>
            <a href="${article.url}" target="_blank" class="news-link">Read more</a>
          `;
          newsContainer.appendChild(newsItem);
        });

        newsFeed.appendChild(newsContainer);
        updateKPIs(Array.from(uniqueArticles.values()));
      } catch (error) {
        console.error('Error fetching news:', error);
        newsFeed.innerHTML = `
          <div class="error-message">
            <p>Error loading news. Please try again later.</p>
            <p class="error-details">${error.message}</p>
            <p>If this error persists, please check your internet connection or try again later.</p>
          </div>
        `;
      }
    }

    function updateKPIs(articles) {
      // Update News Volume
      document.getElementById('newsVolume').textContent = articles.length;

      // Calculate Market Sentiment
      const sentimentKeywords = {
        positive: ['rise', 'gain', 'growth', 'surge', 'bullish', 'strength'],
        negative: ['fall', 'drop', 'decline', 'bearish', 'weakness', 'loss']
      };

      let positiveCount = 0;
      let negativeCount = 0;

      articles.forEach(article => {
        const text = (article.title + ' ' + article.description).toLowerCase();
        sentimentKeywords.positive.forEach(keyword => {
          if (text.includes(keyword)) positiveCount++;
        });
        sentimentKeywords.negative.forEach(keyword => {
          if (text.includes(keyword)) negativeCount++;
        });
      });

      const sentiment = positiveCount > negativeCount ? 'Bullish' : 
                       negativeCount > positiveCount ? 'Bearish' : 'Neutral';
      document.getElementById('marketSentiment').textContent = sentiment;

      // Find Top Currency
      const currencyMentions = {};
      const currencies = ['USD', 'EUR', 'GBP', 'JPY', 'INR', 'CNY', 'AUD', 'CAD'];
      
      articles.forEach(article => {
        const text = (article.title + ' ' + article.description).toUpperCase();
        currencies.forEach(currency => {
          if (text.includes(currency)) {
            currencyMentions[currency] = (currencyMentions[currency] || 0) + 1;
          }
        });
      });

      const topCurrency = Object.entries(currencyMentions)
        .sort((a, b) => b[1] - a[1])[0];
      
      document.getElementById('topCurrency').textContent = topCurrency ? 
        `${topCurrency[0]} (${topCurrency[1]} mentions)` : 'No data';
    }

    // Initial news fetch
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, fetching news...');
      fetchNews();
    });

    // Update news every 30 minutes
    setInterval(fetchNews, 30 * 60 * 1000);

    // Initial chart update
    updateChart();

    // Update chart every 5 minutes
    setInterval(updateChart, 5 * 60 * 1000);
  </script>
</body>
</html>
